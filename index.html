<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nosmero - Nostr + Monero</title>
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs@gh-pages/qrcode.min.js"></script>
    <link rel="stylesheet" href="/styles.css?v=1.9.15-wallet">
    <link rel="stylesheet" href="/css/livestream.css?v=1.0.1">

    <!-- HLS.js for livestream video playback (self-hosted for privacy browser compatibility) -->
    <script src="/lib/hls.min.js"></script>
</head>
<body>
    <!-- ==================================
         NEW MINIMAL HEADER & HAMBURGER MENU
         ================================== -->

    <!-- Menu Overlay for Slide-out Menu -->
    <div class="menu-overlay" id="menuOverlay" onclick="closeHamburgerMenu()"></div>

    <!-- Slide-out Hamburger Menu -->
    <nav class="slide-menu" id="slideMenu">
        <div class="menu-header">
            <span style="font-weight: 600; color: var(--text-primary);">Menu</span>
            <button class="menu-close" onclick="closeHamburgerMenu()">âœ•</button>
        </div>
        <div class="menu-nav">
            <!-- Auth Options (shown when anonymous) - AT TOP for easy access -->
            <div id="menuLoginOptions" style="display: none; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem;">
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; padding: 0 16px; font-weight: 600;">GET STARTED</div>
                <div class="menu-item" onclick="showCreateAccountModal(); closeHamburgerMenu();">
                    <span class="menu-icon">âœ¨</span>
                    <span style="color: #FF6600;">Create Account</span>
                </div>
                <div class="menu-item" onclick="showLoginModalWithLogin(); closeHamburgerMenu();">
                    <span class="menu-icon">ğŸ”‘</span>
                    <span>Log In</span>
                </div>
                <div style="padding: 12px 16px; color: #666; font-size: 12px;">
                    Already on Nostr?
                </div>
                <div class="menu-item" onclick="loginWithExtension(); closeHamburgerMenu();">
                    <span class="menu-icon">ğŸ”Œ</span>
                    <span>Use Extension</span>
                </div>
                <div class="menu-item" onclick="showLoginWithNsec(); closeHamburgerMenu();">
                    <span class="menu-icon">ğŸ“</span>
                    <span>Paste nsec</span>
                </div>
                <div class="menu-item" onclick="showLoginWithNsecApp(); closeHamburgerMenu();">
                    <span class="menu-icon">ğŸŒ</span>
                    <span>nsec.app</span>
                </div>
                <div class="menu-item" onclick="showLoginWithAmber(); closeHamburgerMenu();">
                    <span class="menu-icon">ğŸ“±</span>
                    <span>Amber</span>
                </div>
            </div>
            <!-- Feed Selection -->
            <div style="border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem;">
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; padding: 0 16px; font-weight: 600;">FEEDS</div>
                <div class="menu-item" onclick="handleFeedMenuClick('following')">
                    <span class="menu-icon">ğŸ‘¥</span>
                    <span>Following</span>
                </div>
                <div class="menu-item" onclick="handleFeedMenuClick('live')">
                    <span class="menu-icon">ğŸ“º</span>
                    <span>Live Streams</span>
                </div>
                <div class="menu-item" onclick="handleFeedMenuClick('global')">
                    <span class="menu-icon">ğŸŒ</span>
                    <span>Suggested Follows</span>
                </div>
                <div class="menu-item" onclick="handleFeedMenuClick('tipactivity')">
                    <span class="menu-icon">ğŸ’°</span>
                    <span>Monero Tip Activity</span>
                </div>
                <div class="menu-item" onclick="handleFeedMenuClick('trending')">
                    <span class="menu-icon">ğŸ“ˆ</span>
                    <span>Popular Notes</span>
                </div>
                <div class="menu-item" onclick="handleFeedMenuClick('monero')">
                    <span class="menu-icon">ğŸ”¥</span>
                    <span>Trending Monero Notes</span>
                </div>
            </div>

            <!-- Navigation Items -->
            <div class="menu-item" data-tab="home" onclick="handleMenuItemClick('home')">
                <span class="menu-icon">ğŸ </span>
                <span>Home</span>
            </div>
            <div class="menu-item" data-tab="search" onclick="handleMenuItemClick('search')">
                <span class="menu-icon">ğŸ”</span>
                <span>Search</span>
            </div>
            <div class="menu-item" data-tab="messages" onclick="handleMenuItemClick('messages')">
                <span class="menu-icon">ğŸ’¬</span>
                <span>Messages</span>
            </div>
            <div class="menu-item" data-tab="profile" onclick="handleMenuItemClick('profile')">
                <span class="menu-icon">ğŸ‘¤</span>
                <span>Profile</span>
            </div>
            <div class="menu-item" data-tab="settings" onclick="handleMenuItemClick('settings')">
                <span class="menu-icon">âš™ï¸</span>
                <span>Settings</span>
            </div>
            <div class="menu-item" onclick="openWalletModal(); closeHamburgerMenu();" style="background: linear-gradient(135deg, rgba(255, 102, 0, 0.1), rgba(139, 92, 246, 0.1)); border: 1px solid rgba(255, 102, 0, 0.3); border-radius: 8px; margin: 8px 16px;">
                <span class="menu-icon">â›ï¸</span>
                <span style="background: linear-gradient(135deg, #FF6600, #8B5CF6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 600;">XMR Tip Jar</span>
            </div>
            <div class="menu-item" onclick="showZapQueue(); closeHamburgerMenu();" style="position: relative;">
                <span class="menu-icon">ğŸ’°</span>
                <span>Tip Queue</span>
                <span id="menuQueueBadge" style="position: absolute; right: 16px; background: linear-gradient(135deg, #FF6600, #8B5CF6); color: #000; border-radius: 12px; min-width: 20px; height: 20px; font-size: 11px; font-weight: bold; display: none; justify-content: center; align-items: center; padding: 0 6px;">0</span>
            </div>
            <div class="menu-item" onclick="toggleTheme()">
                <span class="menu-icon" id="themeIconMenu">ğŸŒ™</span>
                <span id="themeLabelMenu">Dark Mode</span>
            </div>
            <div class="menu-item" onclick="window.location.href='https://nosmero.com/set-desktop-preference'">
                <span class="menu-icon">ğŸ–¥ï¸</span>
                <span>Desktop Site</span>
            </div>
            <div class="menu-item" onclick="toggleCompose()" id="menuCreateNoteBtn" style="display: none;">
                <span class="menu-icon">âœï¸</span>
                <span>Create Note</span>
            </div>
            <!-- Logged-in user info -->
            <div id="menuUserInfo" style="display: none; margin-top: auto; padding: 1rem; border-top: 1px solid var(--border-color); background: rgba(255, 255, 255, 0.02);">
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">Logged in as</div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <img id="menuUserPic" src="" alt="Profile" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border-color);">
                    <div style="flex: 1; min-width: 0;">
                        <div id="menuUserName" style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></div>
                        <div id="menuUserNpub" style="font-size: 11px; font-family: monospace; color: var(--text-secondary);"></div>
                    </div>
                </div>
            </div>
            <!-- Logout button at bottom -->
            <div class="menu-item" onclick="logout()" id="menuLogoutBtn" style="display: none; border-top: 1px solid var(--border-color); padding-top: 1rem;">
                <span class="menu-icon">ğŸšª</span>
                <span style="color: #ff6b6b;">Logout</span>
            </div>
        </div>
    </nav>

    <!-- Minimal Fixed Header - Single Row Layout -->
    <header class="minimal-header">
        <div class="header-single-row">
            <button class="mobile-menu-btn" onclick="openHamburgerMenu()" aria-label="Open menu">â˜°</button>
            <div class="logo-container">
                <img src="/nosmero-logo-new.png" alt="nosmero" class="header-logo">
                <span class="tagline">nostr + monero</span>
            </div>

            <nav class="feed-selector">
                <a href="#" class="feed-tab active" data-feed="following" onclick="handleFeedTabClick('following', event)">Following</a>
                <a href="#" class="feed-tab" data-feed="live" onclick="handleFeedTabClick('live', event)">ğŸ“º Live</a>
                <a href="#" class="feed-tab" data-feed="tipactivity" onclick="handleFeedTabClick('tipactivity', event)">Monero Tip Activity</a>
                <a href="#" class="feed-tab" data-feed="global" onclick="handleFeedTabClick('global', event)">Web of Trust Feed</a>
                <a href="#" class="feed-tab" data-feed="monero" onclick="handleFeedTabClick('monero', event)">Trending Monero Notes</a>
                <button class="create-note-btn" id="headerCreateNoteBtn" onclick="handleCreateNoteClick()" style="display: none;">
                    âœï¸ <span>Post</span>
                </button>
                <button class="notifications-btn" id="headerNotificationsBtn" onclick="handleNavItemClick('notifications')" style="display: none; position: relative;">
                    ğŸ””
                    <span id="notificationBadge" style="position: absolute; top: -4px; right: -4px; background: #FF6600; color: white; border-radius: 10px; min-width: 18px; height: 18px; padding: 0 5px; font-size: 11px; font-weight: bold; display: none; justify-content: center; align-items: center;"></span>
                </button>
                <button class="login-btn-orange" id="headerLoginBtn" onclick="showLoginOptions()">
                    Login
                </button>
            </nav>

            <div class="quick-actions">
                <div class="relay-indicator" id="relayIndicator">
                    <div class="status-dot"></div>
                    <span id="relayCount">0 relays connected</span>
                </div>
            </div>
        </div>
    </header>

    <!-- ==================================
         END NEW HEADER & MENU
         ================================== -->

    <!-- LEGACY: Keep existing sidebar hidden for backward compatibility -->
    <div class="sidebar" style="display: none;">
        <div class="logo">
            <img src="/nosmero-logo-new.png" alt="nosmero" style="width: 120px; height: auto;">
        </div>
        
        <div class="nav-item active" data-tab="home" onclick="handleNavItemClick('home')">
            <span>ğŸ </span>
            <span>Home</span>
        </div>
        
        <div class="nav-item" data-tab="settings" onclick="handleNavItemClick('settings')">
            <span>âš™ï¸</span>
            <span>Settings</span>
        </div>
        
        <div class="nav-item" data-tab="search" onclick="handleNavItemClick('search')">
            <span>ğŸ”</span>
            <span>Search</span>
        </div>
        
        <div class="nav-item" data-tab="messages" onclick="handleNavItemClick('messages')" style="position: relative;">
            <span>âœ‰ï¸</span>
            <span>Messages</span>
            <span id="messagesBadge" style="position: absolute; top: 8px; right: 8px; background: #FF6600; color: white; border-radius: 10px; min-width: 18px; height: 18px; padding: 0 5px; font-size: 11px; font-weight: bold; display: none; justify-content: center; align-items: center;"></span>
        </div>

        <div class="nav-item" data-tab="notifications" onclick="handleNavItemClick('notifications')" style="position: relative;">
            <span>ğŸ””</span>
            <span>Notifications</span>
            <span id="notificationBadge" style="position: absolute; top: 8px; right: 8px; background: #FF6600; color: white; border-radius: 10px; min-width: 18px; height: 18px; padding: 0 5px; font-size: 11px; font-weight: bold; display: none; justify-content: center; align-items: center;"></span>
        </div>
        
        <div class="nav-item" data-tab="profile" onclick="handleNavItemClick('profile')">
            <span>ğŸ‘¤</span>
            <span>Profile</span>
        </div>

        <!-- Theme Toggle -->
        <div class="nav-item" onclick="toggleTheme()" style="cursor: pointer;">
            <span id="themeIcon">ğŸŒ™</span>
            <span id="themeLabel">Dark</span>
        </div>

        <!-- Login/Create Account Options (shown when not logged in) -->
        <div id="authOptions" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #333;">
            <button class="login-option-btn" onclick="showCreateAccount()" style="width: 100%; margin-bottom: 10px; padding: 10px; background: linear-gradient(135deg, #FF6600, #8B5CF6); border: none; color: white; border-radius: 8px; cursor: pointer;">
                ğŸ†• Create Account
            </button>
            <button class="login-option-btn" onclick="showLoginWithNsec()" style="width: 100%; margin-bottom: 10px; padding: 10px; background: #333; border: none; color: white; border-radius: 8px; cursor: pointer;">
                ğŸ”‘ Login with nsec
            </button>
            <button class="login-option-btn" onclick="loginWithExtension()" style="width: 100%; margin-bottom: 10px; padding: 10px; background: #333; border: none; color: white; border-radius: 8px; cursor: pointer;">
                ğŸ”Œ Use Extension
            </button>
            <button class="login-option-btn" onclick="showLoginWithNsecApp()" style="width: 100%; margin-bottom: 10px; padding: 10px; background: #333; border: none; color: white; border-radius: 8px; cursor: pointer;">
                ğŸŒ Use nsec.app
            </button>
            <button class="login-option-btn" onclick="showLoginWithAmber()" style="width: 100%; margin-bottom: 10px; padding: 10px; background: #333; border: none; color: white; border-radius: 8px; cursor: pointer;">
                ğŸ“± Use Amber
            </button>
        </div>
        
        <!-- Logout Option (shown when logged in) -->
        <div id="logoutOption" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #333;">
            <button onclick="logout()" style="width: 100%; padding: 10px; background: #333; border: none; color: #ff6b6b; border-radius: 8px; cursor: pointer;">
                ğŸšª Logout
            </button>
        </div>
        
        <button class="post-button" onclick="toggleCompose()">âœï¸ Create Note</button>

        <button class="post-button" onclick="showZapQueue()" style="position: relative; margin-top: 10px;">
            ğŸ’° XMR Queue
            <span class="zap-queue-indicator" style="position: absolute; top: -5px; right: -5px; background: linear-gradient(135deg, #FF6600, #8B5CF6); color: #000; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; font-weight: bold; display: none; justify-content: center; align-items: center;">0</span>
        </button>

        <div class="nav-item" onclick="logout()" style="margin-top: 10px; background: linear-gradient(135deg, #FF6600, #8B5CF6); border-radius: 12px; color: #fff;">
            <span>ğŸšª</span>
            <span style="color: #fff; font-weight: bold;">Logout</span>
        </div>
    </div>

    <div class="main">
        <!-- Contact List Sync Status Indicator -->
        <div id="contactSyncStatus" class="sync-status-banner" style="display: none; background: linear-gradient(135deg, #FF6600, #8B5CF6); padding: 10px 16px; margin: 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1); color: #fff; font-size: 13px; align-items: center; gap: 10px;">
            <div class="spinner" style="width: 14px; height: 14px; border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
            <span id="contactSyncText">Syncing your follows...</span>
        </div>

        <div id="compose" class="compose-area" style="display: none;">
            <textarea class="compose-textarea" placeholder="What's happening?" maxlength="4000" style="min-height: 120px; resize: vertical;" oninput="updateCharacterCount(this, 'mainCharCount')"></textarea>
            <div style="text-align: right; color: #666; font-size: 12px; margin-bottom: 8px;">
                <span id="mainCharCount">0/4000</span>
            </div>
            <div class="compose-actions">
                <input type="text" class="xmr-address-input" placeholder="Your Monero address (optional)" id="composeMoneroAddress">

                <!-- Paywall Toggle -->
                <div class="paywall-toggle-container">
                    <div class="paywall-toggle-row">
                        <div class="paywall-toggle">
                            <input type="checkbox" id="paywallEnabled" onchange="NostrPaywall.togglePaywall(this.checked)">
                            <label for="paywallEnabled">ğŸ”’ Paywall this note</label>
                        </div>
                        <div id="paywallPriceInput" class="paywall-price-input">
                            <input type="number" id="paywallPrice" placeholder="0.00015" step="0.00001" min="0.00001" value="0.00015">
                            <span>XMR</span>
                        </div>
                    </div>
                    <div id="paywallPreviewSection" class="paywall-preview-section">
                        <div class="paywall-preview-header" onclick="NostrPaywall.togglePreviewEdit()">
                            <span>Preview text (shown to non-payers)</span>
                            <span id="paywallPreviewToggle" class="paywall-preview-toggle">â–¼ Edit</span>
                        </div>
                        <div id="paywallPreviewSuggested" class="paywall-preview-suggested"></div>
                        <div id="paywallPreviewEdit" class="paywall-preview-edit">
                            <textarea id="paywallPreviewText" placeholder="Auto-generated from first paragraph..." rows="3"></textarea>
                            <div class="paywall-preview-hint">Leave empty to auto-generate from your post's first paragraph</div>
                        </div>
                    </div>
                </div>

                <div class="media-upload-section">
                    <input type="file" id="composeMediaInput" accept="image/*,video/*" style="display: none;" onchange="handleMediaUpload(this, 'compose')">
                    <div id="composeMediaPreview" class="media-preview" style="display: none;"></div>
                </div>
                <div class="compose-buttons">
                    <button class="media-btn" onclick="document.getElementById('composeMediaInput').click()" title="Add Image/Video">
                        ğŸ“ Media
                    </button>
                    <button class="cancel-btn" onclick="cancelCompose()">Cancel</button>
                    <button class="send-btn" onclick="sendPost()">Publish</button>
                </div>
            </div>
        </div>

        <div class="feed" id="feed">
            <!-- Welcome Banner for First-Time Anonymous Users -->
            <div class="welcome-banner hidden" id="welcomeBanner">
                <button class="close-banner" onclick="closeWelcomeBanner()">âœ•</button>
                <h2 class="welcome-title">Welcome to Nosmero ğŸ‘‹</h2>
                <p class="welcome-text">
                    You are viewing the top notes regarding the Monero community. To post or send tips, just generate your keys - takes 5 seconds, no email needed.
                </p>
                <div class="welcome-actions">
                    <button class="welcome-btn primary" onclick="handleCreateKeysAndPost()">Create Keys & Post</button>
                    <a href="#" class="welcome-btn secondary" onclick="showWhatIsNostr()">What's Nostr?</a>
                    <a href="#" class="welcome-btn secondary" onclick="showWhatIsMonero()">What's Monero?</a>
                </div>
            </div>

            <div class="loading">Loading nostr-tools...</div>
        </div>
        
        <!-- Messages page (hidden by default) -->
        <div id="messagesPage" class="messages-page" style="display: none;">
            <div class="messages-container">
                <div class="conversations-list">
                    <div class="conversations-header">
                        <h2>Messages</h2>
                        <button class="new-message-btn" onclick="startNewMessage()">
                            <span>âœ‰ï¸ New</span>
                        </button>
                    </div>
                    <div id="conversationsList" class="conversations">
                        <!-- Conversations will be listed here -->
                    </div>
                </div>
                <div class="message-thread">
                    <div id="messageHeader" class="message-header">
                        <span>Select a conversation</span>
                    </div>
                    <div id="messageThread" class="messages-display">
                        <!-- Messages will appear here -->
                    </div>
                    <div id="messageComposer" class="message-composer" style="display: none;">
                        <textarea id="messageInput" placeholder="Type your message..." rows="3"></textarea>
                        <button onclick="sendMessage()" class="send-message-btn">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Thread page (hidden by default) -->
        <div id="threadPage" class="thread-page" style="display: none;">
            <div class="thread-header">
                <button onclick="goBackFromThread()" style="background: none; border: none; color: #fff; cursor: pointer; font-size: 18px; margin-right: 12px;">â†</button>
                <h2>Thread</h2>
            </div>
            <div id="threadPageContent" class="thread-content">
                <!-- Thread will be displayed here -->
            </div>
        </div>

        <div id="profilePage" class="profile-page" style="display: none;">
            <!-- User profile will be displayed here -->
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content" style="max-width: 480px;">
            <div class="modal-header" id="loginModalHeader">Log In</div>

            <!-- Main Login Buttons -->
            <div id="loginMainButtons">
                <!-- Returning User Login Section -->
                <div id="returningUserSection" class="hidden">
                    <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
                        <button class="login-option-btn" onclick="loginWithExtension()">
                            <span style="margin-right: 8px;">ğŸ”Œ</span> Browser Extension
                        </button>
                        <button class="login-option-btn" onclick="showLoginWithNsecSection()">
                            <span style="margin-right: 8px;">ğŸ”‘</span> Paste nsec
                        </button>
                        <button class="login-option-btn" onclick="showLoginWithNsecApp()">
                            <span style="margin-right: 8px;">ğŸŒ</span> nsec.app
                        </button>
                        <button class="login-option-btn" onclick="showLoginWithAmberSection()">
                            <span style="margin-right: 8px;">ğŸ“±</span> Amber (Android)
                        </button>
                    </div>

                    <div style="display: flex; align-items: center; margin: 20px 0; gap: 12px;">
                        <div style="flex: 1; height: 1px; background: #333;"></div>
                        <span style="color: #666; font-size: 12px;">or with Nosmero username</span>
                        <div style="flex: 1; height: 1px; background: #333;"></div>
                    </div>

                    <form id="loginForm" onsubmit="return false;">
                        <div style="margin-bottom: 12px;">
                            <input type="text" id="emailOrUsernameInput" placeholder="Username Created on Nosmero"
                                   style="width: 100%; padding: 12px; border: 1px solid #333; border-radius: 8px; background: #000; color: #fff; font-size: 14px;">
                        </div>
                        <div style="margin-bottom: 12px;">
                            <input type="password" id="loginPasswordInput" placeholder="Password"
                                   style="width: 100%; padding: 12px; border: 1px solid #333; border-radius: 8px; background: #000; color: #fff; font-size: 14px;">
                        </div>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <button type="submit" id="loginBtn" class="send-btn" onclick="authUI.handleLogin()" style="flex: 1;">Log In</button>
                            <button type="button" class="text-btn" onclick="authUI.showForgotPassword()" style="color: #8B5CF6; font-size: 13px;">Forgot?</button>
                        </div>
                    </form>

                    <div style="text-align: center; margin-top: 20px;">
                        <button class="text-btn" onclick="showCreateAccountModal()" style="color: #FF6600; font-size: 14px;">
                            New to Nostr? Create Account
                        </button>
                    </div>
                </div>

                <!-- Quick Login Buttons (legacy, hidden by default) -->
                <div id="quickLoginSection" class="hidden"></div>
            </div>

            <!-- New User Section - Choose Method -->
            <div id="newUserSection" class="hidden">
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="login-option-btn" onclick="showEmailPasswordSignup()" style="text-align: left; padding: 16px;">
                        <div style="font-weight: 600; margin-bottom: 4px;">Create with Username/Password</div>
                        <div style="font-size: 12px; color: #888;">Familiar login experience - Nostr keys generated & encrypted with your password</div>
                        <div style="font-size: 11px; color: #8B5CF6; margin-top: 4px;">Export your nsec/npub anytime to use elsewhere</div>
                    </button>
                    <button class="login-option-btn" onclick="showKeysOnlySignup()" style="text-align: left; padding: 16px;">
                        <div style="font-weight: 600; margin-bottom: 4px;">Just Generate Keys</div>
                        <div style="font-size: 12px; color: #888;">Advanced - You save and manage your own keys</div>
                    </button>
                </div>
                <div style="text-align: center; margin-top: 16px;">
                    <button class="text-btn" onclick="showLoginModalWithLogin()" style="color: #8B5CF6; font-size: 14px;">
                        Already have an account? Log In
                    </button>
                </div>
            </div>

            <!-- Email/Password Signup Form (Username-only, no email stored) -->
            <div id="emailPasswordSignupSection" class="hidden">
                <form id="signupForm" onsubmit="return false;">
                    <!-- Display Name -->
                    <div style="margin-bottom: 16px;">
                        <input type="text" id="displayNameInput" placeholder="Display name (e.g., John Smith)"
                               style="width: 100%; padding: 14px; border: 1px solid #333; border-radius: 8px; background: #000; color: #fff; font-size: 15px;">
                        <div style="font-size: 11px; color: #888; margin-top: 4px;">Public - This name appears on your posts and profile</div>
                    </div>

                    <!-- Username (required) -->
                    <div style="margin-bottom: 12px;">
                        <input type="text" id="signupUsernameInput" placeholder="Username (you'll log in with this)"
                               style="width: 100%; padding: 12px; border: 1px solid #333; border-radius: 8px; background: #000; color: #fff; font-size: 14px;"
                               oninput="checkUsernameAvailability(this.value)">
                        <div style="font-size: 11px; color: #888; margin-top: 2px;">Private - Only you see this. Letters, numbers, underscore (3-20 chars)</div>
                        <div id="usernameAvailability" style="font-size: 11px; margin-top: 2px; min-height: 16px;"></div>
                    </div>

                    <!-- Password with strength indicator -->
                    <div style="margin-bottom: 12px;">
                        <input type="password" id="signupPasswordInput" placeholder="Password (min 8 characters)"
                               style="width: 100%; padding: 12px; border: 1px solid #333; border-radius: 8px; background: #000; color: #fff; font-size: 14px;"
                               oninput="updatePasswordStrength(this.value)">
                        <!-- Password strength meter -->
                        <div style="margin-top: 8px;">
                            <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                                <div id="strengthBar1" style="flex: 1; height: 4px; background: #333; border-radius: 2px;"></div>
                                <div id="strengthBar2" style="flex: 1; height: 4px; background: #333; border-radius: 2px;"></div>
                                <div id="strengthBar3" style="flex: 1; height: 4px; background: #333; border-radius: 2px;"></div>
                                <div id="strengthBar4" style="flex: 1; height: 4px; background: #333; border-radius: 2px;"></div>
                            </div>
                            <div id="strengthText" style="font-size: 11px; color: #888;"></div>
                        </div>
                    </div>

                    <!-- Confirm Password -->
                    <div style="margin-bottom: 12px;">
                        <input type="password" id="confirmPasswordInput" placeholder="Confirm password"
                               style="width: 100%; padding: 12px; border: 1px solid #333; border-radius: 8px; background: #000; color: #fff; font-size: 14px;">
                    </div>

                    <!-- Password security explanation -->
                    <div style="margin-bottom: 16px; padding: 12px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border: 1px solid rgba(139, 92, 246, 0.2);">
                        <div style="color: #8B5CF6; font-weight: 600; font-size: 12px; margin-bottom: 6px;">Why password strength matters</div>
                        <div style="color: #aaa; font-size: 11px; line-height: 1.5;">
                            Your password encrypts your private key. If Nosmero's database were ever compromised, a strong password protects your identity from being stolen. Use 12+ characters with mixed case, numbers, and symbols.
                        </div>
                    </div>

                    <!-- Optional nsec backup email -->
                    <div style="margin-bottom: 16px; padding: 12px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; border: 1px solid #333;">
                        <label style="display: flex; align-items: flex-start; color: #ccc; font-size: 13px; cursor: pointer;">
                            <input type="checkbox" id="emailBackupCheckbox" onchange="toggleEmailBackup(this.checked)"
                                   style="margin-right: 10px; margin-top: 2px; accent-color: #8B5CF6;">
                            <div>
                                <span style="font-weight: 500;">Email me my nsec backup</span>
                                <div style="font-size: 11px; color: #888; margin-top: 2px;">One-time send only - your email is NOT stored</div>
                            </div>
                        </label>
                        <div id="emailBackupContainer" style="display: none; margin-top: 12px;">
                            <input type="email" id="signupEmailInput" placeholder="Email for one-time nsec backup"
                                   style="width: 100%; padding: 10px; border: 1px solid #333; border-radius: 6px; background: #000; color: #fff; font-size: 13px;">
                            <div style="font-size: 10px; color: #666; margin-top: 4px;">We send your nsec once, then permanently delete your email from our systems</div>
                        </div>
                    </div>

                    <button type="submit" id="createAccountBtn" class="send-btn" onclick="authUI.handleSignup()" style="width: 100%;">
                        Create Account
                    </button>
                </form>
                <button class="close-btn" onclick="showCreateAccountModal()" style="margin-top: 12px;">Back</button>
            </div>

            <!-- Keys Only Signup Form -->
            <div id="keysOnlySignupSection" class="hidden">
                <form id="keysOnlyForm" onsubmit="return false;">
                    <div style="margin-bottom: 16px;">
                        <input type="text" id="keysOnlyDisplayNameInput" placeholder="Display name (e.g., John Smith)"
                               style="width: 100%; padding: 14px; border: 1px solid #333; border-radius: 8px; background: #000; color: #fff; font-size: 15px;">
                        <div style="font-size: 11px; color: #888; margin-top: 4px;">Your public name shown on your profile</div>
                    </div>
                    <div style="margin-bottom: 16px; padding: 12px; background: rgba(255, 102, 0, 0.1); border-radius: 8px; border-left: 3px solid #FF6600;">
                        <div style="color: #FF6600; font-size: 13px; line-height: 1.5;">
                            Your keys will be generated and shown once. Save them securely - if lost, your account cannot be recovered.
                        </div>
                    </div>
                    <button type="submit" class="send-btn" onclick="authUI.handleKeysOnlySignup()" style="width: 100%;">
                        Generate My Keys
                    </button>
                </form>
                <button class="close-btn" onclick="showCreateAccountModal()" style="margin-top: 12px;">Back</button>
            </div>

            <!-- Forgot Password Section -->
            <div id="forgotPasswordSection" class="hidden">
                <div style="margin-bottom: 16px; color: #ccc; font-size: 14px;">
                    Enter your email to receive a password reset link.
                </div>
                <div style="margin-bottom: 16px; padding: 12px; background: rgba(255, 102, 0, 0.1); border-radius: 8px; border-left: 3px solid #FF6600;">
                    <div style="color: #FF6600; font-size: 13px;">
                        Note: Password reset requires your nsec backup.
                    </div>
                </div>
                <form id="forgotPasswordForm" onsubmit="return false;">
                    <div style="margin-bottom: 16px;">
                        <input type="email" id="forgotEmailInput" placeholder="Email address"
                               style="width: 100%; padding: 14px; border: 1px solid #333; border-radius: 8px; background: #000; color: #fff; font-size: 15px;">
                    </div>
                    <button type="submit" id="forgotPasswordBtn" class="send-btn" onclick="authUI.handleForgotPassword()" style="width: 100%;">
                        Send Reset Link
                    </button>
                </form>
                <button class="close-btn" onclick="authUI.backToMainLogin()" style="margin-top: 12px;">Back</button>
            </div>

            <!-- Login with nsec Section -->
            <div id="loginWithNsecSection" class="hidden">
                <div style="margin-bottom: 16px;">
                    <input type="password" id="nsecInput" placeholder="Enter your nsec..."
                           style="width: 100%; padding: 12px; border: 1px solid #333; border-radius: 8px; background: #000; color: #fff; font-size: 14px;">
                </div>
                <div style="margin-bottom: 16px; padding: 14px; background: rgba(255, 102, 0, 0.1); border-radius: 8px; border-left: 3px solid #FF6600;">
                    <div style="color: #FF6600; font-weight: bold; margin-bottom: 8px;">Security Warning</div>
                    <div style="color: #ccc; font-size: 13px; line-height: 1.5;">
                        Your nsec controls your identity permanently. It will be encrypted with a PIN and stored locally.
                    </div>
                </div>

                <button class="send-btn" onclick="loginWithNsec()">Login</button>
                <button class="close-btn" onclick="backToLoginOptions()">Back</button>
            </div>

            <!-- Login with Amber Section -->
            <div id="loginWithAmberSection" class="hidden">
                <div style="margin-bottom: 16px;">
                    <input type="text" id="amberBunkerInput" placeholder="Paste your bunker URI from Amber..."
                           style="width: 100%; padding: 12px; border: 1px solid #333; border-radius: 8px; background: #000; color: #fff; font-size: 14px;">
                </div>
                <div style="margin-bottom: 16px; padding: 12px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border-left: 3px solid #8B5CF6;">
                    <div style="color: #8B5CF6; font-weight: bold; margin-bottom: 8px;">How to get your bunker URI:</div>
                    <ol style="color: #ccc; font-size: 13px; margin: 0; padding-left: 20px; line-height: 1.8;">
                        <li>Open Amber on your Android device</li>
                        <li>Go to Settings - Connections</li>
                        <li>Create or select a connection</li>
                        <li>Copy the bunker:// URI</li>
                    </ol>
                </div>

                <button class="send-btn" onclick="loginWithAmber()">Connect to Amber</button>
                <button class="close-btn" onclick="backToLoginOptions()">Back</button>
            </div>

            <!-- Key Display Section -->
            <div id="keyDisplaySection" class="hidden">
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="color: #FF6600; font-weight: 600;">Your Private Key (nsec)</div>
                        <button onclick="copyToClipboard(document.getElementById('privateKeyDisplay').textContent, this)"
                                style="background: rgba(255, 102, 0, 0.2); border: 1px solid #FF6600; color: #FF6600; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                            ğŸ“‹ Copy
                        </button>
                    </div>
                    <div id="privateKeyDisplay" style="padding: 12px; background: #1a1a1a; border-radius: 8px; font-family: monospace; font-size: 12px; word-break: break-all; color: #FF6600; border: 1px solid rgba(255, 102, 0, 0.3);"></div>
                    <!-- Hidden element to store npub for proceedToApp -->
                    <div id="publicKeyDisplay" style="display: none;"></div>
                </div>

                <div style="background: linear-gradient(135deg, rgba(255, 102, 0, 0.2), rgba(139, 92, 246, 0.2)); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="color: #FF6600; font-weight: bold; margin-bottom: 8px;">Save Your nsec!</div>
                    <div style="color: #ccc; font-size: 14px; line-height: 1.5;">
                        Your <strong>nsec</strong> is your private key - it proves your identity. Save it somewhere safe (password manager, secure note).
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1); color: #888; font-size: 13px;">
                            You can also find and export your nsec from <strong>Settings</strong> after logging in.
                        </div>
                    </div>
                </div>

                <button class="send-btn" onclick="authUI.proceedToApp()">I've Saved It - Continue</button>
            </div>
        </div>
    </div>

    <!-- New Post Modal -->
    <div class="modal" id="newPostModal">
        <div class="modal-content">
            <div class="modal-header">Create Note</div>
            <textarea id="newPostContent" placeholder="What's happening?" maxlength="4000" style="width: 100%; min-height: 150px; padding: 12px; border: 1px solid #333; border-radius: 8px; background: #000; color: #fff; font-size: 16px; resize: vertical;" oninput="updateCharacterCount(this, 'modalCharCount')"></textarea>
            <div style="text-align: right; color: #666; font-size: 12px; margin-top: 4px;">
                <span id="modalCharCount">0/4000</span>
            </div>
            <input type="text" id="modalMoneroAddress" placeholder="Your Monero address (optional)" style="width: 100%; padding: 12px; border: 1px solid #333; border-radius: 8px; background: #000; color: #fff; margin-top: 12px;">
            <div class="media-upload-section">
                <input type="file" id="modalMediaInput" accept="image/*,video/*" style="display: none;" onchange="handleMediaUpload(this, 'modal')">
                <div id="modalMediaPreview" class="media-preview" style="display: none;"></div>
            </div>
            <div class="modal-actions">
                <button class="media-btn" onclick="document.getElementById('modalMediaInput').click()" title="Add Image/Video">
                    ğŸ“ Media
                </button>
                <button class="close-btn" onclick="closeNewPostModal()">Cancel</button>
                <button class="send-btn" onclick="publishNewPost()">Publish</button>
            </div>
        </div>
    </div>
    
    <!-- Reply Modal -->
    <div class="modal" id="replyModal">
        <div class="modal-content">
            <div class="modal-header">Reply to Post</div>
            <div id="replyingTo" style="padding: 12px; background: #1a1a1a; border-radius: 8px; margin-bottom: 16px; font-size: 14px; color: #999;"></div>
            <textarea id="replyContent" placeholder="Write your reply..." maxlength="1000" style="width: 100%; min-height: 120px; padding: 12px; border: 1px solid #333; border-radius: 8px; background: #000; color: #fff; font-size: 16px; resize: vertical;"></textarea>
            
            <!-- Media Upload Section for Replies -->
            <div class="media-upload-section">
                <input type="file" id="replyMediaInput" accept="image/*,video/*" style="display: none;" onchange="handleMediaUpload(this, 'reply')">
                <div id="replyMediaPreview" class="media-preview" style="display: none;"></div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="media-btn" onclick="document.getElementById('replyMediaInput').click()" title="Add Image/Video">
                    ğŸ“ Media
                </button>
                <button class="close-btn" onclick="closeReplyModal()">Cancel</button>
                <button class="send-btn" onclick="sendReplyToCurrentPost()">Reply</button>
            </div>
        </div>
    </div>

    <!-- Repost Modal -->
    <div class="modal" id="repostModal">
        <div class="modal-content">
            <div class="modal-header">Repost</div>
            <div id="repostingTo" style="padding: 12px; background: #1a1a1a; border-radius: 8px; margin-bottom: 16px; font-size: 14px; color: #999;"></div>

            <!-- Repost Type Toggle -->
            <div style="margin-bottom: 16px;">
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <button id="quickRepostBtn" onclick="setRepostType('quick')" style="flex: 1; padding: 8px 16px; border: 1px solid #FF6600; border-radius: 6px; background: linear-gradient(135deg, #FF6600, #8B5CF6); color: #000; font-weight: bold; cursor: pointer;">Quick Repost</button>
                    <button id="addCommentBtn" onclick="setRepostType('comment')" style="flex: 1; padding: 8px 16px; border: 1px solid #333; border-radius: 6px; background: transparent; color: #fff; cursor: pointer;">Add Comment</button>
                </div>
                <div id="quickRepostDesc" style="color: #666; font-size: 14px;">Share this note to your followers without adding commentary</div>
                <div id="addCommentDesc" style="color: #666; font-size: 14px; display: none;">Quote this note and add your own commentary</div>
            </div>

            <!-- Comment Section (hidden by default) -->
            <div id="repostCommentSection" style="display: none; margin-bottom: 16px;">
                <textarea id="repostComment" placeholder="Add your thoughts..." maxlength="1000" style="width: 100%; min-height: 100px; padding: 12px; border: 1px solid #333; border-radius: 8px; background: #000; color: #fff; font-size: 16px; resize: vertical;"></textarea>
            </div>

            <div class="modal-actions">
                <button class="close-btn" onclick="closeRepostModal()">Cancel</button>
                <button id="repostBtn" class="send-btn" onclick="sendRepost()">Repost</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">Settings</div>
            
            <div class="settings-section">
                <h3>Lightning Address</h3>
                <input type="text" id="defaultLightningAddress" placeholder="Your Lightning address (e.g., user@domain.com)" style="width: 100%; padding: 8px; border: 1px solid #333; border-radius: 8px; background: #000; color: #fff;">
                <p style="color: #999; font-size: 12px; margin-top: 8px;">Used for receiving Bitcoin zaps via Lightning Network</p>
            </div>

            <div class="settings-section">
                <h3>Banner Image URL</h3>
                <input type="text" id="defaultBannerImage" placeholder="Your profile banner image URL" style="width: 100%; padding: 8px; border: 1px solid #333; border-radius: 8px; background: #000; color: #fff;">
                <p style="color: #999; font-size: 12px; margin-top: 8px;">Banner image displayed on your profile page</p>
            </div>

            <div class="settings-section">
                <h3>Default Monero Address</h3>
                <input type="text" id="defaultMoneroAddress" placeholder="Your default XMR address" style="width: 100%; padding: 8px; border: 1px solid #333; border-radius: 8px; background: #000; color: #fff;">
            </div>

            <div class="settings-section">
                <h3>Default Zap Amounts</h3>
                <div style="display: flex; gap: 20px; margin-top: 12px;">
                    <div style="flex: 1;">
                        <label style="color: #FFDF00; display: block; margin-bottom: 8px;">âš¡ Bitcoin (sats)</label>
                        <input type="number" id="defaultBtcZapAmount" placeholder="1000" min="1" style="width: 100%; padding: 8px; border: 1px solid #333; border-radius: 8px; background: #000; color: #fff;">
                    </div>
                    <div style="flex: 1;">
                        <label style="color: #FF6600; display: block; margin-bottom: 8px;">âš¡ Monero (XMR)</label>
                        <input type="text" id="defaultXmrZapAmount" placeholder="0.001" step="0.001" style="width: 100%; padding: 8px; border: 1px solid #333; border-radius: 8px; background: #000; color: #fff;">
                    </div>
                </div>
                <p style="color: #999; font-size: 12px; margin-top: 8px;">Set default amounts for quick zapping</p>
            </div>

            <div class="settings-section">
                <h3>Relay Configuration (NIP-65)</h3>
                <p style="color: #999; font-size: 12px; margin-bottom: 12px;">Configure which relays you read from and write to</p>
                
                <div style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <h4 style="color: #FF6600; margin-bottom: 8px;">Read Relays</h4>
                        <div id="readRelaysList" style="margin-bottom: 12px; max-height: 150px; overflow-y: auto;"></div>
                        <input type="text" id="newReadRelayUrl" placeholder="wss://relay.example.com" style="width: 100%; padding: 8px; border: 1px solid #333; border-radius: 8px; background: #000; color: #fff; margin-bottom: 8px;">
                        <button onclick="addReadRelay()" style="padding: 8px 16px; background: linear-gradient(135deg, #FF6600, #8B5CF6); border: none; border-radius: 8px; color: #000; font-weight: bold; cursor: pointer; width: 100%;">Add Read Relay</button>
                    </div>
                    
                    <div style="flex: 1;">
                        <h4 style="color: #8B5CF6; margin-bottom: 8px;">Write Relays</h4>
                        <div id="writeRelaysList" style="margin-bottom: 12px; max-height: 150px; overflow-y: auto;"></div>
                        <input type="text" id="newWriteRelayUrl" placeholder="wss://relay.example.com" style="width: 100%; padding: 8px; border: 1px solid #333; border-radius: 8px; background: #000; color: #fff; margin-bottom: 8px;">
                        <button onclick="addWriteRelay()" style="padding: 8px 16px; background: linear-gradient(135deg, #8B5CF6, #FF6600); border: none; border-radius: 8px; color: #000; font-weight: bold; cursor: pointer; width: 100%;">Add Write Relay</button>
                    </div>
                </div>
                
                <div style="margin-top: 12px; padding: 8px; background: #111; border-radius: 8px;">
                    <button onclick="resetToDefaultRelays()" style="padding: 6px 12px; background: #333; border: none; border-radius: 6px; color: #fff; cursor: pointer; margin-right: 8px;">Reset to Defaults</button>
                    <button onclick="importRelayList()" style="padding: 6px 12px; background: #333; border: none; border-radius: 6px; color: #fff; cursor: pointer;">Import from Profile</button>
                </div>
            </div>

            <div class="settings-section">
                <h3>Direct Messages</h3>
                <div style="margin-top: 12px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="useNip17Dms" style="width: 18px; height: 18px; cursor: pointer;">
                        <span>Use NIP-17 encrypted DMs (enhanced privacy)</span>
                    </label>
                    <div style="margin-top: 8px; padding: 12px; background: #1a1a00; border-left: 3px solid #FFDF00; border-radius: 4px;">
                        <p style="color: #FFDF00; font-size: 12px; margin: 0;">âš ï¸ <strong>Only works with other Nosmero users</strong> who have this enabled.</p>
                        <p style="color: #999; font-size: 12px; margin: 4px 0 0 0;">Messages to other clients will automatically use standard encryption (NIP-04).</p>
                    </div>
                    <p style="color: #666; font-size: 11px; margin-top: 8px;">
                        NIP-17 provides enhanced privacy by hiding message metadata from relays. However, it only works when both sender and recipient use Nosmero with this setting enabled.
                    </p>
                </div>
            </div>

            <div class="settings-section">
                <h3>Muted Users</h3>
                <p style="color: #999; font-size: 12px; margin-bottom: 12px;">Users you've muted won't appear in your feed or tip disclosures</p>
                <div id="mutedUsersList" style="max-height: 200px; overflow-y: auto; background: #111; border-radius: 8px; padding: 8px;">
                    <!-- Muted users will be populated by JavaScript -->
                </div>
            </div>

            <div class="settings-section">
                <h3>ğŸ” Web of Trust</h3>
                <p style="color: #999; font-size: 12px; margin-bottom: 16px;">NIP-85 trust scoring powered by Relatr</p>

                <!-- Master Switch -->
                <div class="trust-badges-toggle" style="margin-bottom: 16px;">
                    <div>
                        <div class="trust-badges-label">Enable Web of Trust</div>
                        <div class="trust-badges-description" style="color: #666; font-size: 11px; margin-top: 2px;">
                            Calculate trust scores using Relatr
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="enableWebOfTrust" checked onchange="toggleWebOfTrust(this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <!-- Sub-options (enabled when Web of Trust is on) -->
                <div id="webOfTrustOptions" style="margin-left: 20px; padding-left: 16px; border-left: 2px solid #333;">

                    <!-- Always show on Suggested Follows & New Voices -->
                    <div style="margin-bottom: 12px; padding: 8px; background: rgba(255, 102, 0, 0.05); border-radius: 6px;">
                        <div style="color: #FF6600; font-size: 12px; font-weight: 600; margin-bottom: 4px;">
                            âœ“ Badges shown on Suggested Follows & New Voices
                        </div>
                        <div style="color: #999; font-size: 11px;">
                            Trust scores help discover quality accounts
                        </div>
                    </div>

                    <!-- Show badges on all feeds -->
                    <div class="trust-badges-toggle" style="margin-bottom: 16px;">
                        <div>
                            <div class="trust-badges-label">Show badges on all feeds</div>
                            <div class="trust-badges-description" style="color: #666; font-size: 11px; margin-top: 2px;">
                                Display scores on home feed, profiles, threads, etc.
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="showTrustBadgesEverywhere" onchange="toggleTrustBadgesEverywhere(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <!-- Personalize scores -->
                    <div class="trust-badges-toggle" style="margin-bottom: 16px;">
                        <div>
                            <div class="trust-badges-label">Personalize scores to my network</div>
                            <div class="trust-badges-description" style="color: #666; font-size: 11px; margin-top: 2px;">
                                Calculate from your perspective vs global network
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="personalizeScores" checked onchange="togglePersonalizeScores(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <!-- Share data with network -->
                    <div class="trust-badges-toggle">
                        <div>
                            <div class="trust-badges-label">Share my scores with the network</div>
                            <div class="trust-badges-description" style="color: #666; font-size: 11px; margin-top: 2px;">
                                Help improve trust calculations for others
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="shareDataWithRelatr" onchange="toggleShareData(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div style="margin-top: 8px; padding: 8px; background: rgba(139, 92, 246, 0.05); border-left: 3px solid #8B5CF6; border-radius: 4px;">
                        <p style="color: #ccc; font-size: 11px; margin: 0;">
                            â„¹ï¸ Your follow list is already public on Nostr. This allows the Nosmero trust server to use it for network-wide calculations.
                        </p>
                    </div>
                </div>

                <!-- Info box -->
                <div style="margin-top: 16px; padding: 12px; background: rgba(255, 102, 0, 0.05); border-left: 3px solid #FF6600; border-radius: 4px;">
                    <p style="color: #ccc; font-size: 12px; margin: 0;">
                        Trust scores are calculated based on social graph distance, NIP-05 verification, Lightning addresses, and relay list publication. Scores range from 0-100, with higher scores indicating more trusted users.
                    </p>
                </div>
            </div>

            <div class="settings-section">
                <h3>Notifications</h3>
                <p style="color: #999; font-size: 12px; margin-bottom: 12px;">Choose which types of notifications to receive</p>
                <div style="display: grid; gap: 12px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="notif_replies" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span>ğŸ’¬ Replies to my posts</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="notif_mentions" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span>ğŸ“¢ Mentions of me</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="notif_likes" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span>â¤ï¸ Likes on my posts</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="notif_reposts" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span>ğŸ”„ Reposts of my posts</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="notif_zaps" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span>âš¡ Zaps & Tips (Lightning + Monero)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="notif_follows" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span>ğŸ‘¥ New followers</span>
                    </label>
                </div>
                <p style="color: #666; font-size: 11px; margin-top: 12px;">
                    Disabled notification types won't be fetched from relays. Changes take effect on next notification refresh.
                </p>
            </div>

            <div class="modal-actions">
                <button class="close-btn" onclick="closeSettingsModal()">Close</button>
                <button class="send-btn" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal" id="profileModal">
        <div class="modal-content">
            <div class="modal-header">Profile</div>
            <div id="profileContent"></div>
            <div class="modal-actions">
                <button class="close-btn" onclick="closeProfileModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div class="modal" id="userProfileModal">
        <div class="modal-content">
            <div id="userProfileContent"></div>
            <div class="modal-actions">
                <button class="close-btn" onclick="closeUserProfileModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Thread View Modal -->
    <div class="modal" id="threadModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">Thread</div>
            <div id="threadContent" style="max-height: 70vh; overflow-y: auto;"></div>
            <div class="modal-actions">
                <button class="close-btn" onclick="closeThreadModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Zap Modal -->
    <div class="modal" id="zapModal">
        <div class="modal-content">
            <div class="modal-header">Tip with Monero</div>
            <div id="zapDetails"></div>
            <div class="qr-container">
                <div id="qrCode"></div>
            </div>
            <div class="modal-footer">
                <div style="font-size: 12px; color: #666; margin-bottom: 16px;">
                    Scan with your Monero wallet
                </div>
                <button class="close-btn" onclick="closeZapModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- XMR Wallet Modal (Full-screen, z-index higher than bottom nav) -->
    <div class="modal" id="walletModal" style="display: none; z-index: 2000;">
        <div class="modal-content" style="max-width: 100%; width: 100%; height: 100%; margin: 0; border-radius: 0; display: flex; flex-direction: column;">
            <!-- Wallet Modal Header -->
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px; border-bottom: 1px solid var(--border-color); background: #0a0a0a;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button onclick="closeWalletModal()" style="background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; padding: 4px;">â†</button>
                    <h2 id="walletModalTitle" style="margin: 0; font-size: 18px; background: linear-gradient(135deg, #FF6600, #8B5CF6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">â›ï¸ XMR Tip Jar</h2>
                </div>
                <button id="walletLockBtn" onclick="lockWallet()" style="background: none; border: 1px solid var(--border-color); color: var(--text-secondary); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; display: none;">ğŸ”’ Lock</button>
            </div>

            <!-- Wallet Modal Content (scrollable) -->
            <div id="walletModalContent" style="flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 100px;">
                <!-- Content will be dynamically rendered by wallet-modal.js -->
                <div style="text-align: center; padding: 40px;">
                    <div class="sync-spinner" style="width: 40px; height: 40px; margin: 0 auto 20px; border: 3px solid #333; border-top-color: #FF6600; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="color: #999;">Loading wallet...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- PIN Entry Modal (for encrypted key storage) -->
    <div class="modal" id="pinModal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">ğŸ” Secure Your Account</div>
            <div style="padding: 20px;">
                <p id="pinModalMessage" style="margin-bottom: 20px; color: #ccc;">Create a PIN to encrypt your private key</p>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: #999;">Enter PIN (4-8 digits)</label>
                    <input type="password" id="pinInput"
                           placeholder="Enter PIN..."
                           maxlength="8"
                           style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 6px; color: #fff; font-size: 16px; text-align: center; letter-spacing: 4px;">
                </div>

                <div id="pinConfirmSection" style="margin-bottom: 20px; display: none;">
                    <label style="display: block; margin-bottom: 8px; color: #999;">Confirm PIN</label>
                    <input type="password" id="pinConfirmInput"
                           placeholder="Confirm PIN..."
                           maxlength="8"
                           style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 6px; color: #fff; font-size: 16px; text-align: center; letter-spacing: 4px;">
                </div>

                <div style="background: rgba(255, 102, 0, 0.1); border: 1px solid rgba(255, 102, 0, 0.3); border-radius: 6px; padding: 12px; margin-top: 16px;">
                    <div style="color: #FF6600; font-weight: bold; margin-bottom: 4px;">âš ï¸ Important</div>
                    <div style="color: #999; font-size: 13px;">
                        Your PIN encrypts your private key in browser storage. Don't forget it - we cannot recover it!
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="send-btn" id="pinSubmitBtn" onclick="submitPin()"
                        style="background: linear-gradient(135deg, #FF6600, #8B5CF6);">Continue</button>
                <button class="close-btn" id="pinCancelBtn" onclick="cancelPin()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Disclosure Prompt Modal -->
    <div class="modal" id="disclosurePromptModal">
        <div class="modal-content" style="max-width: 650px;">
            <div class="modal-header">ğŸ’° Tip Disclosure Options</div>
            <div style="padding: 20px;">
                <p style="margin-bottom: 20px; color: #ccc;">Choose how you want to handle this tip:</p>

                <!-- Option A: Keep it Secret -->
                <label style="display: block; padding: 14px; margin-bottom: 12px; background: rgba(100, 100, 100, 0.1); border: 2px solid #444; border-radius: 8px; cursor: pointer; transition: all 0.2s;"
                       onmouseover="this.style.background='rgba(100,100,100,0.15)'; this.style.borderColor='#666';"
                       onmouseout="this.style.background='rgba(100,100,100,0.1)'; this.style.borderColor='#444';">
                    <div style="display: flex; align-items: start;">
                        <input type="radio" name="disclosureOption" value="secret" checked onchange="updateDisclosureOption()"
                               style="margin-right: 12px; margin-top: 4px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 15px; color: #fff; margin-bottom: 4px;">ğŸ”’ Keep it Secret</div>
                            <div style="font-size: 13px; color: #999;">No public record of this tip</div>
                        </div>
                    </div>
                </label>

                <!-- Option B: Disclose (No Verification) -->
                <label style="display: block; padding: 14px; margin-bottom: 12px; background: rgba(255, 102, 0, 0.1); border: 2px solid rgba(255, 102, 0, 0.3); border-radius: 8px; cursor: pointer; transition: all 0.2s;"
                       onmouseover="this.style.background='rgba(255,102,0,0.15)'; this.style.borderColor='rgba(255,102,0,0.5)';"
                       onmouseout="this.style.background='rgba(255,102,0,0.1)'; this.style.borderColor='rgba(255,102,0,0.3)';">
                    <div style="display: flex; align-items: start;">
                        <input type="radio" name="disclosureOption" value="disclose" onchange="updateDisclosureOption()"
                               style="margin-right: 12px; margin-top: 4px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 15px; color: #FF6600; margin-bottom: 4px;">ğŸ’° Disclose (No Verification)</div>
                            <div style="font-size: 13px; color: #999;">Honor system, no cryptographic proof</div>
                        </div>
                    </div>
                </label>

                <!-- Option C: Disclose + Verify -->
                <label style="display: block; padding: 14px; margin-bottom: 20px; background: rgba(16, 185, 129, 0.1); border: 2px solid rgba(16, 185, 129, 0.3); border-radius: 8px; cursor: pointer; transition: all 0.2s;"
                       onmouseover="this.style.background='rgba(16,185,129,0.15)'; this.style.borderColor='rgba(16,185,129,0.5)';"
                       onmouseout="this.style.background='rgba(16,185,129,0.1)'; this.style.borderColor='rgba(16,185,129,0.3)';">
                    <div style="display: flex; align-items: start;">
                        <input type="radio" name="disclosureOption" value="verify" onchange="updateDisclosureOption()"
                               style="margin-right: 12px; margin-top: 4px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 15px; color: #10B981; margin-bottom: 4px;">âœ“ Disclose + Verify</div>
                            <div style="font-size: 13px; color: #999;">Cryptographically verified with blockchain proof. Verified badge displayed publicly on the note.</div>
                        </div>
                    </div>
                </label>

                <!-- Message Field (shown for all public options) -->
                <div id="messageSection" style="display: none; margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: #999; font-size: 14px;">Message (optional)</label>
                    <textarea id="disclosurePromptMessage" rows="3"
                              placeholder="Add a message with your tip..."
                              style="width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 6px; color: #fff; resize: vertical;"></textarea>
                </div>

                <!-- Verification Fields (shown only for verify options) -->
                <div id="verificationFields" style="display: none; padding: 16px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; margin-bottom: 16px;">
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; color: #aaa; font-size: 13px;">Transaction ID (TXID)</label>
                        <input type="text" id="verificationTxid"
                               placeholder="Get from your wallet's transaction history..."
                               style="width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 6px; color: #fff; font-family: monospace; font-size: 12px;">
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; color: #aaa; font-size: 13px;">Transaction Key (tx_key)</label>
                        <input type="text" id="verificationTxKey"
                               placeholder="Run: get_tx_key <txid> in your wallet..."
                               style="width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 6px; color: #fff; font-family: monospace; font-size: 12px;">
                        <div style="font-size: 11px; color: #666; margin-top: 4px;">
                            CLI: get_tx_key &lt;txid&gt; | GUI: Right-click transaction â†’ Get transaction key
                        </div>
                    </div>

                    <div style="padding: 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 6px;">
                        <div style="font-size: 12px; color: #aaa; line-height: 1.6;">
                            <strong style="color: #10B981;">ğŸ” Privacy-First Verification</strong><br>
                            Your transaction details (TXID & tx_key) will be:<br>
                            â€¢ Verified instantly against the Monero blockchain<br>
                            â€¢ Proof hash published publicly (not the TXID or tx_key)<br>
                            â€¢ Never stored in logs or databases<br>
                            â€¢ Discarded immediately after verification
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="send-btn" onclick="submitDisclosurePrompt()"
                        style="background: linear-gradient(135deg, #FF6600, #8B5CF6);">Confirm</button>
                <button class="close-btn" onclick="closeDisclosurePromptModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Zap Queue Modal -->
    <div class="modal" id="zapQueueModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">XMR Zap Queue</div>
            <div id="zapQueueContent">
                <!-- Queue content will be dynamically populated -->
            </div>
            <div class="modal-footer">
                <button class="send-btn" onclick="showBatchQrCodes()" style="background: linear-gradient(135deg, #FF6600, #8B5CF6);">Process Queue</button>
                <button class="close-btn" onclick="closeZapQueueModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Paywall Unlock Modal -->
    <div id="paywallModalOverlay" class="paywall-modal-overlay" onclick="NostrPaywall.closeModal(event)">
        <div class="paywall-modal" onclick="event.stopPropagation()">
            <div class="paywall-modal-header">
                <h3>Unlock Content</h3>
                <button class="paywall-modal-close" onclick="NostrPaywall.closeModal()">&times;</button>
            </div>
            <div id="paywallModalContent">
                <!-- Content injected dynamically -->
            </div>
        </div>
    </div>

    <!-- Post Menu -->
    <div id="postMenu" class="post-menu" style="display: none;">
        <button onclick="copyPostLink()">Copy Link</button>
        <button onclick="copyPostId()">Copy Note ID</button>
        <button onclick="copyPostJson()">Copy JSON</button>
        <button onclick="viewPostSource()">View Source</button>
        <button onclick="requestDeletion()" style="color: #ff6b6b;">Request Deletion</button>
        <button onclick="muteUser()">Mute User</button>
        <button onclick="reportPost()">Report</button>
    </div>

    <!-- Generated Key Modal -->
    <div class="modal" id="keyModal">
        <!-- Content will be generated by JavaScript -->
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer"></div>

    <!-- Mobile Bottom Navigation Bar -->
    <nav class="mobile-bottom-nav">
        <button class="nav-btn" onclick="handleBottomNavClick('home')" data-nav="home">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-label">Home</span>
        </button>
        <button class="nav-btn" onclick="handleBottomNavClick('search')" data-nav="search">
            <span class="nav-icon">ğŸ”</span>
            <span class="nav-label">Search</span>
        </button>
        <button class="nav-btn nav-btn-primary" onclick="handleBottomNavClick('compose')" data-nav="compose" id="bottomNavCompose" style="display: none;">
            <span class="nav-icon">âœï¸</span>
            <span class="nav-label">Post</span>
        </button>
        <button class="nav-btn" onclick="handleBottomNavClick('messages')" data-nav="messages">
            <span class="nav-icon">ğŸ’¬</span>
            <span class="nav-label">Messages</span>
        </button>
        <button class="nav-btn" onclick="handleBottomNavClick('notifications')" data-nav="notifications" style="position: relative;">
            <span class="nav-icon">ğŸ””</span>
            <span class="nav-label">Alerts</span>
            <span id="bottomNotificationBadge" style="position: absolute; top: 4px; right: 8px; background: #FF6600; color: white; border-radius: 10px; min-width: 18px; height: 18px; padding: 0 5px; font-size: 11px; font-weight: bold; display: none; justify-content: center; align-items: center;"></span>
        </button>
    </nav>

    <!-- Security: DOMPurify for XSS protection -->
    <script src="/lib/purify.min.js"></script>

    <!-- Load nostr-tools from local copy -->
    <script src="/lib/nostr-tools.bundle.js"></script>

    <!-- Monero wallet WASM library for paywall/wallet features -->
    <!-- SRI hash protects against supply chain attacks on the WASM bundle -->
    <script src="/lib/monero-wallet.iife.js" integrity="sha384-/bPHoGgNd6VwHiBPUzapfjKCa5QgS4l77vrHImA0Bmku2+QIezVJCxmPnArNZQBi" crossorigin="anonymous"></script>

    <!-- UI Redesign JS - New minimal header, hamburger menu, feed tabs -->
    <script src="/js/ui-redesign.js?v=3.3.0"></script>

    <!-- Load the modular v2 application -->
    <script type="module" src="/js/app.js?v=2.9.67"></script>

    <!-- Wallet Modal (loaded after app) -->
    <script type="module" src="/js/wallet-modal.js?v=1.0.5"></script>

</body>
</html>