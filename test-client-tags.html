<!DOCTYPE html>
<html>
<head>
    <title>Test Client Tags</title>
    <script src="https://unpkg.com/nostr-tools@2.7.2/lib/nostr.bundle.js"></script>
    <style>
        body { font-family: monospace; padding: 20px; background: #000; color: #0f0; }
        pre { background: #111; padding: 10px; border: 1px solid #333; overflow-x: auto; }
        button { padding: 10px 20px; margin: 10px 0; background: #FF6600; color: #000; border: none; cursor: pointer; font-weight: bold; }
        .event { margin: 10px 0; padding: 10px; background: #111; border-left: 3px solid #FF6600; }
    </style>
</head>
<body>
    <h1>Nosmero Client Tag Tester</h1>
    <p>This will query relays for events with client=nosmero tag</p>

    <button onclick="testQuery()">Query Relays for client=nosmero</button>
    <button onclick="checkYourEvents()">Check Your Recent Events</button>
    <button onclick="checkRelayPropagation()">Check Which Relays Have Your Tagged Events</button>

    <div id="results"></div>

    <script>
        const RELAYS = [
            'wss://relay.damus.io',
            'wss://relay.primal.net',
            'wss://nos.lol',
            'wss://relay.nostr.band',
            'wss://nostr.wine',
            'wss://nostr.xmr.rocks',
            'wss://xmr.ithurtswhenip.ee',
            'wss://xmr.usenostr.org'
        ];

        async function testQuery() {
            const results = document.getElementById('results');
            results.innerHTML = '<p>Querying relays for client=nosmero tags...</p>';

            try {
                const pool = new window.NostrTools.SimplePool();
                const since = Math.floor(Date.now() / 1000) - (7 * 24 * 60 * 60); // 7 days ago

                console.log('Query filter:', {
                    kinds: [1, 6, 7],
                    '#client': ['nosmero'],
                    since: since,
                    limit: 100
                });

                const events = await pool.querySync(RELAYS, {
                    kinds: [1, 6, 7],
                    '#client': ['nosmero'],
                    since: since,
                    limit: 100
                });

                pool.close(RELAYS);

                results.innerHTML = `
                    <h2>Results: ${events.length} events found with client=nosmero</h2>
                    <p>Query: Last 7 days, kinds [1,6,7], #client=nosmero</p>
                    <p>Relays: ${RELAYS.length} relays queried</p>
                    <hr>
                `;

                if (events.length === 0) {
                    results.innerHTML += '<p style="color: #ff6600;"><strong>NO EVENTS FOUND!</strong></p>';
                    results.innerHTML += '<p>This means either:</p>';
                    results.innerHTML += '<ul>';
                    results.innerHTML += '<li>No posts were made with client=nosmero tag</li>';
                    results.innerHTML += '<li>The events are not propagating to these relays</li>';
                    results.innerHTML += '<li>The tag format is incorrect</li>';
                    results.innerHTML += '</ul>';
                } else {
                    events.sort((a, b) => b.created_at - a.created_at).forEach((event, i) => {
                        const kindName = event.kind === 1 ? 'Note' : event.kind === 6 ? 'Repost' : 'Reaction';
                        const npub = window.NostrTools.nip19.npubEncode(event.pubkey);
                        const shortNpub = npub.substring(0, 12) + '...' + npub.substring(npub.length - 6);
                        const date = new Date(event.created_at * 1000).toLocaleString();
                        const clientTag = event.tags.find(t => t[0] === 'client');

                        results.innerHTML += `
                            <div class="event">
                                <strong>#${i+1} - Kind ${event.kind} (${kindName})</strong><br>
                                Author: ${shortNpub}<br>
                                Time: ${date}<br>
                                Client tag: ${JSON.stringify(clientTag)}<br>
                                Content: ${event.content.substring(0, 100)}${event.content.length > 100 ? '...' : ''}<br>
                                All tags: <pre>${JSON.stringify(event.tags, null, 2)}</pre>
                            </div>
                        `;
                    });
                }

            } catch (error) {
                results.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
                console.error('Query error:', error);
            }
        }

        async function checkYourEvents() {
            const results = document.getElementById('results');

            // Get user's pubkey
            let pubkey = null;
            if (window.nostr) {
                try {
                    pubkey = await window.nostr.getPublicKey();
                } catch (e) {
                    results.innerHTML = '<p style="color: red;">No NIP-07 extension found. Cannot check your events.</p>';
                    return;
                }
            } else {
                results.innerHTML = '<p style="color: red;">No NIP-07 extension found. Cannot check your events.</p>';
                return;
            }

            results.innerHTML = `<p>Querying each relay individually for YOUR events (${pubkey.substring(0, 16)}...)</p>`;

            try {
                const pool = new window.NostrTools.SimplePool();
                const since = Math.floor(Date.now() / 1000) - (7 * 24 * 60 * 60); // 7 days ago

                // Map to track which relays have which events
                const eventsByRelay = new Map();
                const allEvents = new Map(); // Map of eventId -> event data

                // Query each relay individually to see which has which events
                for (const relay of RELAYS) {
                    try {
                        console.log(`Querying ${relay}...`);

                        const events = await pool.querySync([relay], {
                            kinds: [1],
                            authors: [pubkey],
                            since: since,
                            limit: 20
                        });

                        eventsByRelay.set(relay, events);

                        // Add events to master list
                        events.forEach(event => {
                            if (!allEvents.has(event.id)) {
                                allEvents.set(event.id, {
                                    event: event,
                                    relays: []
                                });
                            }
                            allEvents.get(event.id).relays.push(relay);
                        });

                    } catch (error) {
                        console.error(`Error querying ${relay}:`, error);
                        eventsByRelay.set(relay, []);
                    }
                }

                pool.close(RELAYS);

                const npub = window.NostrTools.nip19.npubEncode(pubkey);
                const shortNpub = npub.substring(0, 12) + '...' + npub.substring(npub.length - 6);

                results.innerHTML = `
                    <h2>Your Recent Events: ${allEvents.size} unique events found</h2>
                    <p>Author: ${shortNpub}</p>
                    <p>Time range: Last 7 days</p>
                    <p>Queried: ${RELAYS.length} relays</p>
                    <hr>
                `;

                // Sort events by date (newest first)
                const sortedEvents = Array.from(allEvents.values()).sort((a, b) =>
                    b.event.created_at - a.event.created_at
                );

                sortedEvents.forEach((data, i) => {
                    const event = data.event;
                    const relays = data.relays;
                    const date = new Date(event.created_at * 1000).toLocaleString();
                    const clientTag = event.tags.find(t => t[0] === 'client');
                    const hasClientTag = !!clientTag;

                    // Extract relay hostnames for cleaner display
                    const relayNames = relays.map(r => r.replace('wss://', '').replace('ws://', ''));

                    results.innerHTML += `
                        <div class="event" style="border-left-color: ${hasClientTag ? '#0f0' : '#f00'}">
                            <strong>#${i+1} - ${date}</strong><br>
                            ${hasClientTag ?
                                `<span style="color: #0f0;">✓ HAS client tag: ${JSON.stringify(clientTag)}</span>` :
                                `<span style="color: #f00;">✗ NO client tag!</span>`
                            }<br>
                            <strong>Found on ${relays.length} relay(s):</strong><br>
                            ${relayNames.map(r => `<span style="color: #8B5CF6;">• ${r}</span>`).join('<br>')}<br>
                            <br>
                            Content: ${event.content.substring(0, 100)}${event.content.length > 100 ? '...' : ''}<br>
                            All tags: <pre>${JSON.stringify(event.tags, null, 2)}</pre>
                        </div>
                    `;
                });

                // Summary of relay coverage
                results.innerHTML += `
                    <hr>
                    <h3>Relay Coverage Summary:</h3>
                `;

                const relayStats = [];
                for (const [relay, events] of eventsByRelay) {
                    const eventsWithTag = events.filter(e => e.tags.find(t => t[0] === 'client' && t[1] === 'nosmero'));
                    relayStats.push({
                        relay: relay,
                        totalEvents: events.length,
                        taggedEvents: eventsWithTag.length
                    });
                }

                // Sort by tagged events count
                relayStats.sort((a, b) => b.taggedEvents - a.taggedEvents);

                relayStats.forEach(stat => {
                    const relayName = stat.relay.replace('wss://', '').replace('ws://', '');
                    const color = stat.taggedEvents > 0 ? '#0f0' : stat.totalEvents > 0 ? '#ff6600' : '#666';

                    results.innerHTML += `
                        <div style="padding: 8px; margin: 5px 0; background: rgba(0,0,0,0.3); border-left: 3px solid ${color};">
                            <strong style="color: ${color};">${relayName}</strong><br>
                            Total events: ${stat.totalEvents} |
                            <strong>Events with client=nosmero: ${stat.taggedEvents}</strong>
                        </div>
                    `;
                });

                // Recommendations
                results.innerHTML += `
                    <hr>
                    <h3>Analysis:</h3>
                `;

                const relaysWithTaggedEvents = relayStats.filter(s => s.taggedEvents > 0);
                if (relaysWithTaggedEvents.length === 0) {
                    results.innerHTML += `
                        <p style="color: #f00;"><strong>⚠ PROBLEM:</strong> None of the analytics relays have your client-tagged events!</p>
                        <p>Your events ARE on some relay (that's how we found them), but not on these 8 analytics relays.</p>
                    `;
                } else {
                    results.innerHTML += `
                        <p style="color: #0f0;"><strong>✓ FOUND:</strong> ${relaysWithTaggedEvents.length} relay(s) have your client-tagged events.</p>
                        <p>These relays have your nosmero-tagged posts:</p>
                        <ul>
                            ${relaysWithTaggedEvents.map(s => `<li style="color: #8B5CF6;">${s.relay.replace('wss://', '')}</li>`).join('')}
                        </ul>
                    `;
                }

            } catch (error) {
                results.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
                console.error('Query error:', error);
            }
        }

        async function checkRelayPropagation() {
            const results = document.getElementById('results');

            // Get user's pubkey
            let pubkey = null;
            if (window.nostr) {
                try {
                    pubkey = await window.nostr.getPublicKey();
                } catch (e) {
                    results.innerHTML = '<p style="color: red;">No NIP-07 extension found. Cannot check relay propagation.</p>';
                    return;
                }
            } else {
                results.innerHTML = '<p style="color: red;">No NIP-07 extension found. Cannot check relay propagation.</p>';
                return;
            }

            results.innerHTML = `<p>Checking each relay individually for your client-tagged events...</p>`;

            try {
                const pool = new window.NostrTools.SimplePool();
                const since = Math.floor(Date.now() / 1000) - (7 * 24 * 60 * 60); // 7 days ago

                const relayResults = [];

                // Query each relay individually
                for (const relay of RELAYS) {
                    try {
                        console.log(`Querying ${relay}...`);

                        // Query for user's events with client tag
                        const events = await pool.querySync([relay], {
                            kinds: [1],
                            authors: [pubkey],
                            '#client': ['nosmero'],
                            since: since,
                            limit: 10
                        });

                        relayResults.push({
                            relay: relay,
                            count: events.length,
                            success: true,
                            events: events
                        });
                    } catch (error) {
                        relayResults.push({
                            relay: relay,
                            count: 0,
                            success: false,
                            error: error.message
                        });
                    }
                }

                pool.close(RELAYS);

                const npub = window.NostrTools.nip19.npubEncode(pubkey);
                const shortNpub = npub.substring(0, 12) + '...' + npub.substring(npub.length - 6);

                results.innerHTML = `
                    <h2>Relay Propagation Check</h2>
                    <p>Author: ${shortNpub}</p>
                    <p>Filter: kinds=[1], #client=nosmero, last 7 days</p>
                    <hr>
                `;

                const successfulRelays = relayResults.filter(r => r.success && r.count > 0);
                const emptyRelays = relayResults.filter(r => r.success && r.count === 0);
                const failedRelays = relayResults.filter(r => !r.success);

                results.innerHTML += `
                    <h3 style="color: #0f0;">✓ ${successfulRelays.length} relays have your tagged events</h3>
                `;

                successfulRelays.forEach(r => {
                    results.innerHTML += `
                        <div class="event" style="border-left-color: #0f0;">
                            <strong>${r.relay}</strong><br>
                            Found: ${r.count} events with client=nosmero<br>
                        </div>
                    `;
                });

                results.innerHTML += `
                    <h3 style="color: #ff6600;">⚠ ${emptyRelays.length} relays have NO tagged events</h3>
                `;

                emptyRelays.forEach(r => {
                    results.innerHTML += `
                        <div class="event" style="border-left-color: #ff6600;">
                            <strong>${r.relay}</strong><br>
                            <span style="color: #ff6600;">No events found (may not have propagated yet)</span>
                        </div>
                    `;
                });

                if (failedRelays.length > 0) {
                    results.innerHTML += `
                        <h3 style="color: #f00;">✗ ${failedRelays.length} relays failed</h3>
                    `;

                    failedRelays.forEach(r => {
                        results.innerHTML += `
                            <div class="event" style="border-left-color: #f00;">
                                <strong>${r.relay}</strong><br>
                                <span style="color: #f00;">Error: ${r.error}</span>
                            </div>
                        `;
                    });
                }

                // Recommendations
                results.innerHTML += `
                    <hr>
                    <h3>Analysis & Recommendations:</h3>
                `;

                if (successfulRelays.length === 0) {
                    results.innerHTML += `
                        <p style="color: #f00;"><strong>⚠ ISSUE FOUND:</strong> None of the analytics relays have your tagged events!</p>
                        <p>Possible causes:</p>
                        <ul>
                            <li>Your NIP-65 write relays are different from the analytics relay list</li>
                            <li>Events haven't propagated to these relays yet</li>
                            <li>These relays don't support tag-based queries for 'client'</li>
                        </ul>
                        <p><strong>Solution:</strong> Add these relays to your write relay list in Nosmero settings, OR update analytics.html to query your actual write relays.</p>
                    `;
                } else if (successfulRelays.length < RELAYS.length / 2) {
                    results.innerHTML += `
                        <p style="color: #ff6600;"><strong>⚠ PARTIAL PROPAGATION:</strong> Only ${successfulRelays.length}/${RELAYS.length} relays have your events.</p>
                        <p>This is normal - events may take time to propagate to all relays.</p>
                    `;
                } else {
                    results.innerHTML += `
                        <p style="color: #0f0;"><strong>✓ GOOD PROPAGATION:</strong> ${successfulRelays.length}/${RELAYS.length} relays have your events.</p>
                        <p>Your tagged events are spreading across the network properly.</p>
                    `;
                }

            } catch (error) {
                results.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
                console.error('Query error:', error);
            }
        }
    </script>
</body>
</html>
